<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>UWB Data Visualization</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Roboto", Arial, sans-serif;
                background: #f5f7fa;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: #ffffff;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                color: #2a3f6e;
                font-size: 2.2rem;
                margin-bottom: 8px;
                font-weight: 600;
            }

            .header p {
                color: #4a5a7a;
                font-size: 1rem;
                font-weight: 400;
            }

            .main-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }

            .card {
                background: #ffffff;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                border: 1px solid #e0e4e8;
                transition: box-shadow 0.2s ease;
            }

            .card:hover {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            }

            .card h2 {
                color: #2a3f6e;
                margin-bottom: 15px;
                font-size: 1.4rem;
                font-weight: 500;
                border-bottom: 2px solid #1e88e5;
                padding-bottom: 8px;
            }

            .data-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .data-item {
                text-align: center;
                padding: 12px;
                background: #f0f2f5;
                color: #2a3f6e;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .data-item.stale {
                background: #ffebee;
                color: #c62828;
            }

            .data-item label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 4px;
                font-weight: 500;
            }

            .data-item span {
                font-size: 1.1rem;
                font-weight: 600;
            }

            .status-bar {
                background: #1c2526;
                color: #ffffff;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
                margin-top: 20px;
                font-weight: 500;
            }

            .minimap {
                position: relative;
                width: 100%;
                height: 300px;
                border: 2px solid #1e88e5;
                border-radius: 8px;
                background: linear-gradient(45deg, #e8ecef, #f0f2f5);
                overflow: hidden;
                margin-top: 20px;
            }

            .dot {
                position: absolute;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            }

            .anchor-dot {
                background: #1e88e5;
            }

            .position-dot {
                background: #e53935;
            }

            .raw-avg-dot {
                background: #f57c00;
                width: 14px;
                height: 14px;
            }

            .kalman-avg-dot {
                background: #0288d1;
                width: 14px;
                height: 14px;
            }

            .avg-position-dot {
                background: #43a047;
                width: 16px;
                height: 16px;
                box-shadow: 0 0 12px rgba(67, 160, 71, 0.5);
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>UWB Data Visualization</h1>
                <p>Real-time UWB distance and position data</p>
            </div>

            <div class="main-grid">
                <!-- Distances -->
                <div class="card">
                    <h2>Anchor Distances</h2>
                    <div class="data-grid">
                        <div class="data-item" id="raw_d1_item">
                            <label>Raw d1 (Anchor 1)</label>
                            <span id="raw_d1">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d1_item">
                            <label>Kalman d1 (Anchor 1)</label>
                            <span id="kalman_d1">0.00</span>
                        </div>
                        <div class="data-item" id="raw_d2_item">
                            <label>Raw d2 (Anchor 2)</label>
                            <span id="raw_d2">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d2_item">
                            <label>Kalman d2 (Anchor 2)</label>
                            <span id="kalman_d2">0.00</span>
                        </div>
                        <div class="data-item" id="raw_d3_item">
                            <label>Raw d3 (Anchor 3)</label>
                            <span id="raw_d3">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d3_item">
                            <label>Kalman d3 (Anchor 3)</label>
                            <span id="kalman_d3">0.00</span>
                        </div>
                        <div class="data-item" id="raw_d4_item">
                            <label>Raw d4 (Anchor 4)</label>
                            <span id="raw_d4">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d4_item">
                            <label>Kalman d4 (Anchor 4)</label>
                            <span id="kalman_d4">0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Calculated Positions -->
                <div class="card">
                    <h2>Calculated Positions</h2>
                    <div class="data-grid">
                        <div class="data-item">
                            <label>Anchor 1-2 (Raw)</label>
                            <span id="raw_12">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 1-2 (Kalman)</label>
                            <span id="kalman_12">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 2-3 (Raw)</label>
                            <span id="raw_23">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 2-3 (Kalman)</label>
                            <span id="kalman_23">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 3-4 (Raw)</label>
                            <span id="raw_34">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 3-4 (Kalman)</label>
                            <span id="kalman_34">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 4-1 (Raw)</label>
                            <span id="raw_41">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 4-1 (Kalman)</label>
                            <span id="kalman_41">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Raw Least Squares</label>
                            <span id="raw_ls">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Kalman Least Squares</label>
                            <span id="kalman_ls">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Raw Average Position</label>
                            <span id="raw_avg_pos">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Kalman Average Position</label>
                            <span id="kalman_avg_pos">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Final Average Position</label>
                            <span id="avg_pos">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Distance from Origin</label>
                            <span id="dist_origin">0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Minimap for Visualization -->
            <div class="card">
                <h2>Position Visualization</h2>
                <div class="minimap" id="minimap">
                    <div
                        class="dot anchor-dot"
                        id="anchor1"
                        style="left: 0%; top: 100%"
                    ></div>
                    <div
                        class="dot anchor-dot"
                        id="anchor2"
                        style="left: 100%; top: 100%"
                    ></div>
                    <div
                        class="dot anchor-dot"
                        id="anchor3"
                        style="left: 100%; top: 0%"
                    ></div>
                    <div
                        class="dot anchor-dot"
                        id="anchor4"
                        style="left: 0%; top: 0%"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="raw_12_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="kalman_12_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="raw_23_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="kalman_23_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="raw_34_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="kalman_34_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="raw_41_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="kalman_41_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="raw_ls_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot position-dot"
                        id="kalman_ls_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot raw-avg-dot"
                        id="raw_avg_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot kalman-avg-dot"
                        id="kalman_avg_dot"
                        style="display: none"
                    ></div>
                    <div
                        class="dot avg-position-dot"
                        id="avg_pos_dot"
                        style="display: none"
                    ></div>
                </div>
            </div>

            <div class="status-bar">
                <span id="connectionStatus">Connecting to ROS2...</span>
            </div>
        </div>

        <script>
            const socket = io();
            let mapBounds = { x_max: 229, y_max: 335 };

            socket.on("connect", () => {
                document.getElementById("connectionStatus").innerHTML =
                    "Connected to ROS2";
            });

            socket.on("disconnect", () => {
                document.getElementById("connectionStatus").innerHTML =
                    "Disconnected from ROS2";
            });

            socket.on("mapBounds", (bounds) => {
                mapBounds = bounds;
            });

            socket.on("uwbDataUpdate", (data) => {
                // Update distances and check for staleness
                const currentTime = Date.now() / 1000; // Convert to seconds
                const staleThreshold = 5; // 5 seconds

                ["raw_d1", "raw_d2", "raw_d3", "raw_d4"].forEach(
                    (id, index) => {
                        const element = document.getElementById(id);
                        const item = document.getElementById(`${id}_item`);
                        element.textContent =
                            data.raw_distances[index].toFixed(1);
                        const isStale =
                            currentTime - data.raw_distances_time[index] >
                            staleThreshold;
                        item.classList.toggle("stale", isStale);
                    },
                );

                ["kalman_d1", "kalman_d2", "kalman_d3", "kalman_d4"].forEach(
                    (id, index) => {
                        const element = document.getElementById(id);
                        const item = document.getElementById(`${id}_item`);
                        element.textContent =
                            data.kalman_distances[index].toFixed(1);
                        const isStale =
                            currentTime - data.kalman_distances_time[index] >
                            staleThreshold;
                        item.classList.toggle("stale", isStale);
                    },
                );

                // Update positions
                const pairs = [
                    {
                        id: "raw_12",
                        dot: "raw_12_dot",
                        pos: data.raw_positions[0],
                    },
                    {
                        id: "kalman_12",
                        dot: "kalman_12_dot",
                        pos: data.kalman_positions[0],
                    },
                    {
                        id: "raw_23",
                        dot: "raw_23_dot",
                        pos: data.raw_positions[1],
                    },
                    {
                        id: "kalman_23",
                        dot: "kalman_23_dot",
                        pos: data.kalman_positions[1],
                    },
                    {
                        id: "raw_34",
                        dot: "raw_34_dot",
                        pos: data.raw_positions[2],
                    },
                    {
                        id: "kalman_34",
                        dot: "kalman_34_dot",
                        pos: data.kalman_positions[2],
                    },
                    {
                        id: "raw_41",
                        dot: "raw_41_dot",
                        pos: data.raw_positions[3],
                    },
                    {
                        id: "kalman_41",
                        dot: "kalman_41_dot",
                        pos: data.kalman_positions[3],
                    },
                    { id: "raw_ls", dot: "raw_ls_dot", pos: data.raw_ls_pos },
                    {
                        id: "kalman_ls",
                        dot: "kalman_ls_dot",
                        pos: data.kalman_ls_pos,
                    },
                    {
                        id: "raw_avg_pos",
                        dot: "raw_avg_dot",
                        pos: data.raw_avg_pos,
                    },
                    {
                        id: "kalman_avg_pos",
                        dot: "kalman_avg_dot",
                        pos: data.kalman_avg_pos,
                    },
                    { id: "avg_pos", dot: "avg_pos_dot", pos: data.avg_pos },
                ];

                pairs.forEach(({ id, dot, pos }) => {
                    const element = document.getElementById(id);
                    const dotElement = document.getElementById(dot);
                    if (pos) {
                        element.textContent = `X: ${pos[0].toFixed(2)}, Y: ${pos[1].toFixed(2)}`;
                        const xPercent = (pos[0] / mapBounds.x_max) * 100;
                        const yPercent =
                            ((mapBounds.y_max - pos[1]) / mapBounds.y_max) *
                            100;
                        dotElement.style.left = xPercent + "%";
                        dotElement.style.top = yPercent + "%";
                        dotElement.style.display = "block";
                    } else {
                        element.textContent = "N/A";
                        dotElement.style.display = "none";
                    }
                });

                // Update distance from origin
                document.getElementById("dist_origin").textContent =
                    data.distance_from_origin
                        ? data.distance_from_origin.toFixed(2)
                        : "N/A";
            });
        </script>
    </body>
</html>
