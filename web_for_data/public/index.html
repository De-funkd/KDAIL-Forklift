<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ROS2 Robot Control & UWB Data Visualization</title>
        <script src="/socket.io/socket.io.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Roboto", Arial, sans-serif;
                background: #f5f7fa;
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: #ffffff;
                border-radius: 12px;
                padding: 30px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

            .header h1 {
                color: #2a3f6e;
                font-size: 2.2rem;
                margin-bottom: 8px;
                font-weight: 600;
            }

            .header p {
                color: #4a5a7a;
                font-size: 1rem;
                font-weight: 400;
            }

            .main-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 30px;
            }

            .card {
                background: #ffffff;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                border: 1px solid #e0e4e8;
                transition: box-shadow 0.2s ease;
            }

            .card:hover {
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            }

            .card h2 {
                color: #2a3f6e;
                margin-bottom: 15px;
                font-size: 1.4rem;
                font-weight: 500;
                border-bottom: 2px solid #1e88e5;
                padding-bottom: 8px;
            }

            .data-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .data-item {
                text-align: center;
                padding: 12px;
                background: #f0f2f5;
                color: #2a3f6e;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .data-item.stale {
                background: #ffebee;
                color: #c62828;
            }

            .data-item label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 4px;
                font-weight: 500;
            }

            .data-item span {
                font-size: 1.1rem;
                font-weight: 600;
            }

            .pose-info {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }

            .pose-item {
                text-align: center;
                padding: 12px;
                background: #f0f2f5;
                color: #2a3f6e;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .pose-item label {
                display: block;
                font-size: 0.9rem;
                margin-bottom: 4px;
                font-weight: 500;
            }

            .pose-item span {
                font-size: 1.3rem;
                font-weight: 600;
            }

            .input-group {
                margin-bottom: 12px;
            }

            .input-group label {
                display: block;
                margin-bottom: 5px;
                color: #4a5a7a;
                font-weight: 500;
            }

            .input-group input {
                width: 100%;
                padding: 10px;
                border: 1px solid #d0d5dd;
                border-radius: 6px;
                font-size: 1rem;
                transition: border-color 0.2s ease;
            }

            .input-group input:focus {
                outline: none;
                border-color: #1e88e5;
                box-shadow: 0 0 0 2px rgba(30, 136, 229, 0.1);
            }

            .btn {
                background: #1e88e5;
                color: #ffffff;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: 500;
                transition:
                    background 0.2s ease,
                    box-shadow 0.2s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .btn:hover {
                background: #42a5f5;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .btn:active {
                transform: scale(0.98);
            }

            .btn-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-top: 15px;
            }
            
            .static-mode-active {
                background-color: #f44336 !important;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.7; }
                100% { opacity: 1; }
            }

            .controls-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                max-width: 300px;
                margin: 0 auto;
            }

            .control-btn {
                padding: 15px;
                font-size: 1rem;
                font-weight: 500;
                background: #1e88e5;
                border: none;
                border-radius: 8px;
                color: #ffffff;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                position: relative;
                overflow: hidden;
            }

            .control-btn:hover {
                background: #42a5f5;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .control-btn:active {
                transform: scale(0.98);
            }

            .control-btn.pressed {
                background: #e53935;
                box-shadow: 0 0 12px rgba(229, 57, 53, 0.3);
            }

            .forward {
                grid-column: 2;
            }
            .backward {
                grid-column: 2;
            }
            .rotate-left {
                grid-column: 1;
            }
            .rotate-right {
                grid-column: 3;
            }

            .minimap {
                position: relative;
                width: 100%;
                height: 300px;
                border: 2px solid #1e88e5;
                border-radius: 8px;
                background: linear-gradient(45deg, #e8ecef, #f0f2f5);
                overflow: hidden;
                margin-top: 20px;
            }

            .dot {
                position: absolute;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            }

            .anchor-dot {
                background: #1e88e5;
            }

            .position-dot {
                background: #e53935;
            }

            .raw-avg-dot {
                background: #f57c00;
                width: 14px;
                height: 14px;
            }

            .kalman-avg-dot {
                background: #0288d1;
                width: 14px;
                height: 14px;
            }

            .avg-position-dot {
                background: #43a047;
                width: 16px;
                height: 16px;
                box-shadow: 0 0 12px rgba(67, 160, 71, 0.5);
            }

            .robot-dot {
                position: absolute;
                width: 16px;
                height: 16px;
                background: #e53935;
                border-radius: 50%;
                transform: translate(-50%, -50%);
                box-shadow: 0 0 12px rgba(229, 57, 53, 0.4);
                z-index: 10;
            }

            .robot-arrow {
                position: absolute;
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-bottom: 12px solid #2a3f6e;
                transform: translate(-50%, -100%);
                transform-origin: center bottom;
            }

            .status-bar {
                background: #1c2526;
                color: #ffffff;
                padding: 12px;
                border-radius: 8px;
                text-align: center;
                margin-top: 20px;
                font-weight: 500;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ROS2 Robot Control & UWB Data Visualization</h1>
                <p>Real-time robot control, UWB positioning, and IMU data</p>
            </div>

            <div class="main-grid">
                <!-- Current Pose & IMU -->
                <div class="card">
                    <h2>Current Pose & IMU</h2>
                    <div class="pose-info">
                        <div class="pose-item">
                            <label>X Position</label>
                            <span id="currentX">0.00</span>
                        </div>
                        <div class="pose-item">
                            <label>Y Position</label>
                            <span id="currentY">0.00</span>
                        </div>
                        <div class="pose-item">
                            <label>Yaw Angle (IMU)</label>
                            <span id="currentYaw">0.0°</span>
                        </div>
                    </div>
                    <!-- Mini Map -->
                    <div class="minimap" id="minimap">
                        <div
                            class="dot anchor-dot"
                            id="anchor1"
                            style="left: 0%; top: 100%"
                        ></div>
                        <div
                            class="dot anchor-dot"
                            id="anchor2"
                            style="left: 100%; top: 100%"
                        ></div>
                        <div
                            class="dot anchor-dot"
                            id="anchor3"
                            style="left: 100%; top: 0%"
                        ></div>
                        <div
                            class="dot anchor-dot"
                            id="anchor4"
                            style="left: 0%; top: 0%"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="raw_12_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="kalman_12_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="raw_23_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="kalman_23_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="raw_34_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="kalman_34_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="raw_41_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="kalman_41_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="raw_ls_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot position-dot"
                            id="kalman_ls_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot raw-avg-dot"
                            id="raw_avg_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot kalman-avg-dot"
                            id="kalman_avg_dot"
                            style="display: none"
                        ></div>
                        <div
                            class="dot avg-position-dot"
                            id="avg_pos_dot"
                            style="display: none"
                        ></div>
                        <div class="robot-dot" id="robotDot">
                            <div class="robot-arrow" id="robotArrow"></div>
                        </div>
                    </div>
                </div>

                <!-- Set Destination -->
                <div class="card">
                    <h2>Set Destination</h2>
                    <div class="input-group">
                        <label for="destX">Target X:</label>
                        <input
                            type="number"
                            id="destX"
                            step="0.1"
                            placeholder="Enter X coordinate"
                        />
                    </div>
                    <div class="input-group">
                        <label for="destY">Target Y:</label>
                        <input
                            type="number"
                            id="destY"
                            step="0.1"
                            placeholder="Enter Y coordinate"
                        />
                    </div>
                    <div class="input-group">
                        <label for="destYaw">Target Yaw (degrees):</label>
                        <input
                            type="number"
                            id="destYaw"
                            min="0"
                            max="359"
                            placeholder="Enter yaw angle"
                        />
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="sendDestination()">
                            Navigate to Position
                        </button>
                        <button class="btn" onclick="sendYaw()">
                            Set Orientation
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-grid">
                <!-- Anchor Distances -->
                <div class="card">
                    <h2>Anchor Distances</h2>
                    <div class="data-grid">
                        <div class="data-item" id="raw_d1_item">
                            <label>Raw d1 (Anchor 1)</label>
                            <span id="raw_d1">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d1_item">
                            <label>Kalman d1 (Anchor 1)</label>
                            <span id="kalman_d1">0.00</span>
                        </div>
                        <div class="data-item" id="raw_d2_item">
                            <label>Raw d2 (Anchor 2)</label>
                            <span id="raw_d2">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d2_item">
                            <label>Kalman d2 (Anchor 2)</label>
                            <span id="kalman_d2">0.00</span>
                        </div>
                        <div class="data-item" id="raw_d3_item">
                            <label>Raw d3 (Anchor 3)</label>
                            <span id="raw_d3">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d3_item">
                            <label>Kalman d3 (Anchor 3)</label>
                            <span id="kalman_d3">0.00</span>
                        </div>
                        <div class="data-item" id="raw_d4_item">
                            <label>Raw d4 (Anchor 4)</label>
                            <span id="raw_d4">0.00</span>
                        </div>
                        <div class="data-item" id="kalman_d4_item">
                            <label>Kalman d4 (Anchor 4)</label>
                            <span id="kalman_d4">0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Calculated Positions -->
                <div class="card">
                    <h2>Calculated Positions</h2>
                    <div class="data-grid">
                        <div class="data-item">
                            <label>Anchor 1-2 (Raw)</label>
                            <span id="raw_12">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 1-2 (Kalman)</label>
                            <span id="kalman_12">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 2-3 (Raw)</label>
                            <span id="raw_23">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 2-3 (Kalman)</label>
                            <span id="kalman_23">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 3-4 (Raw)</label>
                            <span id="raw_34">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 3-4 (Kalman)</label>
                            <span id="kalman_34">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 4-1 (Raw)</label>
                            <span id="raw_41">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Anchor 4-1 (Kalman)</label>
                            <span id="kalman_41">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Raw Least Squares</label>
                            <span id="raw_ls">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Kalman Least Squares</label>
                            <span id="kalman_ls">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Raw Average Position</label>
                            <span id="raw_avg_pos">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Kalman Average Position</label>
                            <span id="kalman_avg_pos">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Final Average Position</label>
                            <span id="avg_pos">N/A</span>
                        </div>
                        <div class="data-item">
                            <label>Distance from Origin</label>
                            <span id="dist_origin">0.00</span>
                        </div>
                        <div class="data-item" id="static_min_x_item" style="display: none;">
                            <label>Min X Position</label>
                            <span id="static_min_x">0.00</span>
                        </div>
                        <div class="data-item" id="static_max_x_item" style="display: none;">
                            <label>Max X Position</label>
                            <span id="static_max_x">0.00</span>
                        </div>
                        <div class="data-item" id="static_x_range_item" style="display: none;">
                            <label>X Range (cm)</label>
                            <span id="static_x_range">0.00</span>
                        </div>
                        <div class="data-item" id="static_min_y_item" style="display: none;">
                            <label>Min Y Position</label>
                            <span id="static_min_y">0.00</span>
                        </div>
                        <div class="data-item" id="static_max_y_item" style="display: none;">
                            <label>Max Y Position</label>
                            <span id="static_max_y">0.00</span>
                        </div>
                        <div class="data-item" id="static_y_range_item" style="display: none;">
                            <label>Y Range (cm)</label>
                            <span id="static_y_range">0.00</span>
                        </div>
                        <div class="data-item" id="static_range_item" style="display: none;">
                            <label>Total Range (cm)</label>
                            <span id="static_range">0.00</span>
                        </div>
                        <div class="data-item" id="static_duration_item" style="display: none;">
                            <label>Duration (s)</label>
                            <span id="static_duration">0</span>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn" id="staticModeBtn" onclick="toggleStaticMode()">Start Static Mode</button>
                    </div>
                </div>
            </div>

            <!-- Movement Controls -->
            <div class="card">
                <h2>Movement Controls</h2>
                <div class="controls-grid">
                    <button
                        class="control-btn forward"
                        onmousedown="startMoving('move_fwd')"
                        onmouseup="stopMoving()"
                        ontouchstart="startMoving('move_fwd')"
                        ontouchend="stopMoving()"
                    >
                        Forward
                    </button>
                    <button
                        class="control-btn rotate-left"
                        onmousedown="startMoving('rotate_acw')"
                        onmouseup="stopMoving()"
                        ontouchstart="startMoving('rotate_acw')"
                        ontouchend="stopMoving()"
                    >
                        Rotate Left
                    </button>
                    <button
                        class="control-btn rotate-right"
                        onmousedown="startMoving('rotate_cw')"
                        onmouseup="stopMoving()"
                        ontouchstart="startMoving('rotate_cw')"
                        ontouchend="stopMoving()"
                    >
                        Rotate Right
                    </button>
                    <button
                        class="control-btn backward"
                        onmousedown="startMoving('move_bkw')"
                        onmouseup="stopMoving()"
                        ontouchstart="startMoving('move_bkw')"
                        ontouchend="stopMoving()"
                    >
                        Backward
                    </button>
                </div>
            </div>

            <div class="status-bar">
                <span id="connectionStatus">Connecting to ROS2...</span>
            </div>
        </div>

        <script>
            const socket = io();
            let mapBounds = { x_max: 700, y_max: 702 }; // Updated to match anchor positions
            let currentCommand = null;
            let commandInterval = null;
            let staticMode = false;
            let staticData = {
                minX: Number.MAX_VALUE,
                maxX: Number.MIN_VALUE,
                minY: Number.MAX_VALUE,
                maxY: Number.MIN_VALUE,
                startTime: null,
                sampleCount: 0,
                lastUpdateTime: null,
                updateIntervalId: null
            };

            socket.on("connect", () => {
                document.getElementById("connectionStatus").innerHTML =
                    "Connected to ROS2";
            });

            socket.on("disconnect", () => {
                document.getElementById("connectionStatus").innerHTML =
                    "Disconnected from ROS2";
            });

            socket.on("poseUpdate", (pose) => {
                document.getElementById("currentX").textContent =
                    pose.x.toFixed(2);
                document.getElementById("currentY").textContent =
                    pose.y.toFixed(2);
                document.getElementById("currentYaw").textContent =
                    pose.yaw.toFixed(1) + "°";
                updateMinimap(pose);
    
                // Update static mode tracking if enabled
                if (staticMode && pose.x !== undefined && pose.y !== undefined) {
                    staticData.sampleCount++;
                    staticData.lastUpdateTime = Date.now();
                    
                    if (pose.x < staticData.minX) {
                        staticData.minX = pose.x;
                        document.getElementById("static_min_x").textContent = pose.x.toFixed(2);
                    }
                    if (pose.x > staticData.maxX) {
                        staticData.maxX = pose.x;
                        document.getElementById("static_max_x").textContent = pose.x.toFixed(2);
                    }
                    if (pose.y < staticData.minY) {
                        staticData.minY = pose.y;
                        document.getElementById("static_min_y").textContent = pose.y.toFixed(2);
                    }
                    if (pose.y > staticData.maxY) {
                        staticData.maxY = pose.y;
                        document.getElementById("static_max_y").textContent = pose.y.toFixed(2);
                    }
        
                    // Calculate and update ranges
                    const xRange = staticData.maxX - staticData.minX;
                    const yRange = staticData.maxY - staticData.minY;
                    const totalRange = Math.sqrt(xRange * xRange + yRange * yRange);
                    
                    document.getElementById("static_x_range").textContent = xRange.toFixed(2);
                    document.getElementById("static_y_range").textContent = yRange.toFixed(2);
                    document.getElementById("static_range").textContent = totalRange.toFixed(2);
                    
                    // Update duration
                    const durationSec = ((Date.now() - staticData.startTime) / 1000).toFixed(1);
                    document.getElementById("static_duration").textContent = durationSec;
                }
            });

            socket.on("mapBounds", (bounds) => {
                mapBounds = bounds;
            });

            socket.on("uwbDataUpdate", (data) => {
                // Update distances and check for staleness
                const currentTime = Date.now() / 1000; // Convert to seconds
                const staleThreshold = 5; // 5 seconds

                ["raw_d1", "raw_d2", "raw_d3", "raw_d4"].forEach(
                    (id, index) => {
                        const element = document.getElementById(id);
                        const item = document.getElementById(`${id}_item`);
                        element.textContent =
                            data.raw_distances[index].toFixed(1);
                        const isStale =
                            currentTime - data.raw_distances_time[index] >
                            staleThreshold;
                        item.classList.toggle("stale", isStale);
                    },
                );

                ["kalman_d1", "kalman_d2", "kalman_d3", "kalman_d4"].forEach(
                    (id, index) => {
                        const element = document.getElementById(id);
                        const item = document.getElementById(`${id}_item`);
                        element.textContent =
                            data.kalman_distances[index].toFixed(1);
                        const isStale =
                            currentTime - data.kalman_distances_time[index] >
                            staleThreshold;
                        item.classList.toggle("stale", isStale);
                    },
                );

                // Update positions
                const pairs = [
                    {
                        id: "raw_12",
                        dot: "raw_12_dot",
                        pos: data.raw_positions[0],
                    },
                    {
                        id: "kalman_12",
                        dot: "kalman_12_dot",
                        pos: data.kalman_positions[0],
                    },
                    {
                        id: "raw_23",
                        dot: "raw_23_dot",
                        pos: data.raw_positions[1],
                    },
                    {
                        id: "kalman_23",
                        dot: "kalman_23_dot",
                        pos: data.kalman_positions[1],
                    },
                    {
                        id: "raw_34",
                        dot: "raw_34_dot",
                        pos: data.raw_positions[2],
                    },
                    {
                        id: "kalman_34",
                        dot: "kalman_34_dot",
                        pos: data.kalman_positions[2],
                    },
                    {
                        id: "raw_41",
                        dot: "raw_41_dot",
                        pos: data.raw_positions[3],
                    },
                    {
                        id: "kalman_41",
                        dot: "kalman_41_dot",
                        pos: data.kalman_positions[3],
                    },
                    { id: "raw_ls", dot: "raw_ls_dot", pos: data.raw_ls_pos },
                    {
                        id: "kalman_ls",
                        dot: "kalman_ls_dot",
                        pos: data.kalman_ls_pos,
                    },
                    {
                        id: "raw_avg_pos",
                        dot: "raw_avg_dot",
                        pos: data.raw_avg_pos,
                    },
                    {
                        id: "kalman_avg_pos",
                        dot: "kalman_avg_dot",
                        pos: data.kalman_avg_pos,
                    },
                    { id: "avg_pos", dot: "avg_pos_dot", pos: data.avg_pos },
                ];

                pairs.forEach(({ id, dot, pos }) => {
                    const element = document.getElementById(id);
                    const dotElement = document.getElementById(dot);
                    if (pos) {
                        element.textContent = `X: ${pos[0].toFixed(2)}, Y: ${pos[1].toFixed(2)}`;
                        const xPercent = (pos[0] / mapBounds.x_max) * 100;
                        const yPercent =
                            ((mapBounds.y_max - pos[1]) / mapBounds.y_max) *
                            100;
                        dotElement.style.left = xPercent + "%";
                        dotElement.style.top = yPercent + "%";
                        dotElement.style.display = "block";
                    } else {
                        element.textContent = "N/A";
                        dotElement.style.display = "none";
                    }
                });

                // Update distance from origin
                document.getElementById("dist_origin").textContent =
                    data.distance_from_origin
                        ? data.distance_from_origin.toFixed(2)
                        : "N/A";
            });

            // Update minimap for robot pose
            function updateMinimap(pose) {
                const robotDot = document.getElementById("robotDot");
                const robotArrow = document.getElementById("robotArrow");

                const xPercent = (pose.x / mapBounds.x_max) * 100;
                const yPercent =
                    ((mapBounds.y_max - pose.y) / mapBounds.y_max) * 100;

                const clampedX = Math.max(0, Math.min(100, xPercent));
                const clampedY = Math.max(0, Math.min(100, yPercent));

                robotDot.style.left = clampedX + "%";
                robotDot.style.top = clampedY + "%";

                robotArrow.style.transform = `translate(-50%, -100%) rotate(${pose.yaw}deg)`;
            }

            // Destination functions
            function sendDestination() {
                const x = parseFloat(document.getElementById("destX").value);
                const y = parseFloat(document.getElementById("destY").value);

                if (isNaN(x) || isNaN(y)) {
                    alert("Please enter valid X and Y coordinates");
                    return;
                }

                socket.emit("gotoXY", { x: x, y: y });

                const btn = event.target;
                btn.style.background = "#42a5f5";
                setTimeout(() => {
                    btn.style.background = "#1e88e5";
                }, 300);
            }

            function sendYaw() {
                const yaw = parseFloat(
                    document.getElementById("destYaw").value,
                );

                if (isNaN(yaw)) {
                    alert("Please enter a valid yaw angle");
                    return;
                }

                socket.emit("gotoYaw", yaw);

                const btn = event.target;
                btn.style.background = "#42a5f5";
                setTimeout(() => {
                    btn.style.background = "#1e88e5";
                }, 300);
            }

            // Movement control functions
            function startMoving(command) {
                if (currentCommand === command) return;

                currentCommand = command;

                document.querySelectorAll(".control-btn").forEach((btn) => {
                    btn.classList.remove("pressed");
                });
                event.target.classList.add("pressed");

                socket.emit("motorCommand", command);

                commandInterval = setInterval(() => {
                    socket.emit("motorCommand", command);
                }, 100);
            }

            function stopMoving() {
                if (commandInterval) {
                    clearInterval(commandInterval);
                    commandInterval = null;
                }

                currentCommand = null;

                document.querySelectorAll(".control-btn").forEach((btn) => {
                    btn.classList.remove("pressed");
                });

                socket.emit("motorCommand", "stop");
            }

            // Keyboard controls
            document.addEventListener("keydown", (e) => {
                switch (e.key.toLowerCase()) {
                    case "w":
                        if (currentCommand !== "move_fwd") {
                            startMoving("move_fwd");
                            document
                                .querySelector(".forward")
                                .classList.add("pressed");
                        }
                        break;
                    case "s":
                        if (currentCommand !== "move_bkw") {
                            startMoving("move_bkw");
                            document
                                .querySelector(".backward")
                                .classList.add("pressed");
                        }
                        break;
                    case "a":
                        if (currentCommand !== "rotate_acw") {
                            startMoving("rotate_acw");
                            document
                                .querySelector(".rotate-left")
                                .classList.add("pressed");
                        }
                        break;
                    case "d":
                        if (currentCommand !== "rotate_cw") {
                            startMoving("rotate_cw");
                            document
                                .querySelector(".rotate-right")
                                .classList.add("pressed");
                        }
                        break;
                }
            });

            document.addEventListener("keyup", (e) => {
                switch (e.key.toLowerCase()) {
                    case "w":
                    case "s":
                    case "a":
                    case "d":
                        stopMoving();
                        break;
                }
            });

            // Prevent context menu on buttons
            document.querySelectorAll(".control-btn").forEach((btn) => {
                btn.addEventListener("contextmenu", (e) => e.preventDefault());
            });

            // Static mode function
            function toggleStaticMode() {
                staticMode = !staticMode;
                const btn = document.getElementById("staticModeBtn");
    
                if (staticMode) {
                    // Start static mode
                    btn.textContent = "Stop Static Mode";
                    btn.classList.add("static-mode-active");
        
                    // Reset min/max values
                    staticData = {
                        minX: Number.MAX_VALUE,
                        maxX: Number.MIN_VALUE,
                        minY: Number.MAX_VALUE,
                        maxY: Number.MIN_VALUE,
                        startTime: Date.now(),
                        sampleCount: 0,
                        lastUpdateTime: null,
                        updateIntervalId: null
                    };
        
                    // Show static data items
                    document.getElementById("static_min_x_item").style.display = "flex";
                    document.getElementById("static_max_x_item").style.display = "flex";
                    document.getElementById("static_x_range_item").style.display = "flex";
                    document.getElementById("static_min_y_item").style.display = "flex";
                    document.getElementById("static_max_y_item").style.display = "flex";
                    document.getElementById("static_y_range_item").style.display = "flex";
                    document.getElementById("static_range_item").style.display = "flex";
                    document.getElementById("static_duration_item").style.display = "flex";
        
                    // Initialize with current values if available
                    const currentX = parseFloat(document.getElementById("currentX").textContent);
                    const currentY = parseFloat(document.getElementById("currentY").textContent);
        
                    if (!isNaN(currentX) && !isNaN(currentY)) {
                        staticData.minX = staticData.maxX = currentX;
                        staticData.minY = staticData.maxY = currentY;
                        staticData.sampleCount = 1;
            
                        document.getElementById("static_min_x").textContent = currentX.toFixed(2);
                        document.getElementById("static_max_x").textContent = currentX.toFixed(2);
                        document.getElementById("static_x_range").textContent = "0.00";
                        document.getElementById("static_min_y").textContent = currentY.toFixed(2);
                        document.getElementById("static_max_y").textContent = currentY.toFixed(2);
                        document.getElementById("static_y_range").textContent = "0.00";
                        document.getElementById("static_range").textContent = "0.00";
                        document.getElementById("static_duration").textContent = "0.0";
                    }
                    
                    // Set up a status updater
                    staticData.updateIntervalId = setInterval(() => {
                        const durationSec = ((Date.now() - staticData.startTime) / 1000).toFixed(1);
                        document.getElementById("static_duration").textContent = durationSec;
                        
                        // Check if we're still receiving data
                        if (staticData.lastUpdateTime && (Date.now() - staticData.lastUpdateTime > 3000)) {
                            document.getElementById("connectionStatus").innerHTML = 
                                "Static mode active - " + staticData.sampleCount + " samples collected";
                        }
                    }, 500);
                    
                    document.getElementById("connectionStatus").innerHTML = "Static mode active - Collecting samples...";
                } else {
                    // Stop static mode
                    btn.textContent = "Start Static Mode";
                    btn.classList.remove("static-mode-active");
                    
                    // Clear the update interval
                    if (staticData.updateIntervalId) {
                        clearInterval(staticData.updateIntervalId);
                        staticData.updateIntervalId = null;
                    }
        
                    // Calculate duration
                    const duration = ((Date.now() - staticData.startTime) / 1000).toFixed(1);
                    const xRange = staticData.maxX - staticData.minX;
                    const yRange = staticData.maxY - staticData.minY;
                    const totalRange = Math.sqrt(xRange * xRange + yRange * yRange);
        
                    // Log results
                    console.log(`Static mode results (duration: ${duration}s):`);
                    console.log(`X range: ${staticData.minX.toFixed(2)} to ${staticData.maxX.toFixed(2)} (${xRange.toFixed(2)} cm)`);
                    console.log(`Y range: ${staticData.minY.toFixed(2)} to ${staticData.maxY.toFixed(2)} (${yRange.toFixed(2)} cm)`);
                    console.log(`Total range: ${totalRange.toFixed(2)} cm`);
                    console.log(`Samples collected: ${staticData.sampleCount}`);
                    
                    document.getElementById("connectionStatus").innerHTML = 
                        `Static mode complete - Total range: ${totalRange.toFixed(2)} cm (${staticData.sampleCount} samples)`;
                    
                    // Keep showing the results
                }
            }
            </script>
    </body>
</html>
